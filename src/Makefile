## Actual makefile for project is generated by qmake
## This file contains other targets such as test, doc, etc.
## and calls generated Makefile.

TARGET=RebusCalc
PROJDIR=rebuscalc
TSTTARGET=runTests
PROFILETARGET=profile

.PHONY: profile $(TARGET) doc install uninstall

all: $(TARGET) profile_comp

#### run and compile project ###########################

run:
	test -f $(TARGET) || make $(TARGET)
	./$(TARGET)

$(TARGET): $(PROJDIR)/Makefile
	test -f $(PROJDIR)/debug/RebusCalc && make debug_clear || echo fail
	cd $(PROJDIR) && make && cd ..

debug_clear:
	rm -rf $(PROJDIR)/debug/RebusCalc
	cd $(PROJDIR) && qmake "CONFIG += release" RebusCalc.pro && cd ..
	
$(PROJDIR)/Makefile: $(PROJDIR)/RebusCalc.pro
	cd $(PROJDIR) && qmake "CONFIG+=release" RebusCalc.pro && cd ..

doc: Doxyfile
	doxygen $<

########################################################
############ tests #####################################

test: $(TSTTARGET)
	#test -f $(TSTTARGET) || make tests 
	./$(TSTTARGET)

$(TSTTARGET): tests/tests_build/Makefile
	cd tests/tests_build/ && make && cd ../..

tests/tests_build/Makefile: tests/tests_build/tests.pro
	cd tests/tests_build/ && qmake tests.pro && cd ../../

########################################################
########### profiling ##################################

profile: 
	test -f $(PROFILETARGET) || make profile_comp
	./$(PROFILETARGET)

profile_comp:
	g++ --std=c++11 -pipe -Wall -Wextra -g -pg ./profiling.cpp -o $(PROFILETARGET)

#########################################################

pack:
	echo pack

install: 
	cd $(PROJDIR) && make install && cd ..

uninstall:
	cd $(PROJDIR) && make uninstall && cd ..
	
clean: 
	rm -rf $(TARGET) $(TSTTARGET) $(PROFILETARGET)
	rm -rf doc
	rm -rf *gmon*
	cd tests/tests_build/ && make clean && cd ../../rebuscalc/ && make clean && cd ..
	find . -name \*.pro.user -type f -delete
	find . -name \*.stash -type f -delete
	rm -rf rebuscalc/debug/*
